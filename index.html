<!DOCTYPE html>
<html lang="cs-CZ">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LinkedIn Insights Test Page</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
</head>

<body>
    <h1>LinkedIn Insights Test Page</h1>

    <!-- Form to input PID (shown when no pid parameter is present) -->
    <div id="pid-form" style="display: none;">
        <p>Please enter your LinkedIn Partner ID (PID) to proceed:</p>
        <form id="pid-input-form" method="get">
            <input type="text" name="pid" placeholder="LinkedIn Partner ID" required />
            <button type="submit">Load LinkedIn Insights</button>
        </form>
    </div>

    <!-- Main content (shown when pid parameter is present) -->
    <div id="main-content" style="display: none;">
        <p>LinkedIn Partner ID: <span id="current-pid"></span></p>
        
        <form action="javascript:void(0);" method="get">
            <input type="text" name="identifier" placeholder="Value" />
            <button type="submit">Submit</button>
        </form>

        <a id="conversion-link" href="javascript:void(0);">Test Text</a>
    </div>

    <script type="text/javascript">
        // Check for PID parameter and show appropriate content
        (function() {
            const params = new URLSearchParams(window.location.search);
            const partner_id = params.get("pid");
            
            if (partner_id) {
                // PID is present - show main content and initialize LinkedIn tracking
                document.getElementById("main-content").style.display = "block";
                document.getElementById("current-pid").textContent = partner_id;
                
                // Initialize LinkedIn tracking
                _linkedin_partner_id = partner_id;
                window._linkedin_data_partner_ids = window._linkedin_data_partner_ids || [];
                window._linkedin_data_partner_ids.push(_linkedin_partner_id);
                
                // Load LinkedIn Insights Tag
                (function (l) {
                    if (!l) {
                        window.lintrk = function (a, b) { window.lintrk.q.push([a, b]) };
                        window.lintrk.q = []
                    }
                    var s = document.getElementsByTagName("script")[0];
                    var b = document.createElement("script");
                    b.type = "text/javascript"; b.async = true;
                    b.src = "https://snap.licdn.com/li.lms-analytics/insight.min.js";
                    s.parentNode.insertBefore(b, s);
                })(window.lintrk);
                
                // Set up conversion tracking
                var conversionLink = document.getElementById("conversion-link");
                if (conversionLink) {
                    conversionLink.addEventListener("click", function () {
                        window.lintrk('track', { conversion_id: 19349169 });
                    });
                }
            } else {
                // No PID - show form to input PID
                document.getElementById("pid-form").style.display = "block";
                
                // Handle form submission
                document.getElementById("pid-input-form").addEventListener("submit", function(e) {
                    e.preventDefault();
                    const pidInput = this.querySelector('input[name="pid"]').value.trim();
                    if (pidInput) {
                        // Redirect to current page with PID parameter
                        const currentUrl = new URL(window.location);
                        currentUrl.searchParams.set('pid', pidInput);
                        window.location.href = currentUrl.toString();
                    }
                });
            }
        })();
    </script>

    <div id="output-container" style="margin-top: 20px;">
        <p>Latest Website Actions Request Content:</p>
        <pre id="output"></pre>
    </div>

    <script type="text/javascript">
        function decodeAndFormat(encodedStr) {
            // Step 1: Base64 decode to binary string
            const binaryString = atob(encodedStr);

            // Step 2: Convert binary string to Uint8Array
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }

            // Step 3: Decompress using pako
            const decompressed = pako.ungzip(bytes, { to: 'string' });

            // Step 4: Parse and format JSON
            const json = JSON.parse(decompressed);
            const formatted = JSON.stringify(json, null, 4);

            // Display result
            document.getElementById('output').textContent = formatted;
        }
        const originalFetch = window.fetch;
        window.fetch = async function (...args) {
            if (args[0].includes('https://px.ads.linkedin.com/wa')) {
                decodeAndFormat(args[1].body);
            }
            console.log("Intercepted fetch:", args);
            const response = await originalFetch(...args);
            return response;
        };
    </script>

</body>

</html>